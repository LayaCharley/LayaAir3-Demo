!function(e,t){"use strict";class ExternalSkin{get source(){return this._source}set source(e){this._source=e,e?t.ILaya.loader.load(e,t.Loader.SPINE).then((e=>{!this._source||e&&!e.isCreateFromURL(this._source)||(this.templet=e)})):this.templet=null}set items(e){this._items=e}get items(){return this._items}get templet(){return this._templet}set templet(e){this.init(e)}init(e){this._templet=e,this._templet&&this.flush()}flush(){if(this.target&&this.target.templet&&this._items&&this._templet&&this._templet.skeletonData){if(null==this.target.templet._textures)return;for(let e=this._items.length-1;e>=0;e--){let t=this._items[e],s=t.attachment,i=t.slot,n=t.skin;if(s&&i&&n){let e=null,t=this._templet.skeletonData.skins;for(let i=t.length-1;i>=0;i--)if(t[i].name==n){let n=t[i].attachments;for(let t=n.length-1;t>=0&&(e=n[t][s],!e);t--);break}if(e){let t=e.region.page;this.target.templet._textures[t.name]=t.texture;let s=this.target.getSkeleton().findSlot(i);s&&s.setAttachment(e)}}}}}}class ExternalSkinItem{get skin(){return this._skin}set skin(e){this._skin=e}set slot(e){this._slot=e}get slot(){return this._slot}set attachment(e){this._attachment=e}get attachment(){return this._attachment}}class SpineTexture{constructor(e){this.realTexture=e}getImage(){var e,t,s,i;return{width:null!==(t=null===(e=this.realTexture)||void 0===e?void 0:e.sourceWidth)&&void 0!==t?t:16,height:null!==(i=null===(s=this.realTexture)||void 0===s?void 0:s.sourceHeight)&&void 0!==i?i:16}}setFilters(e,s){if(!this.realTexture)return;let i;i=s===spine.TextureFilter.Nearest?t.FilterMode.Point:t.FilterMode.Bilinear,this.realTexture.bitmap.filterMode=i}convertWrapMode(e){return e==spine.TextureWrap.ClampToEdge?t.WrapMode.Clamp:e==spine.TextureWrap.MirroredRepeat?t.WrapMode.Mirrored:t.WrapMode.Repeat}setWraps(e,t){if(!this.realTexture)return;let s=this.realTexture.bitmap;s.wrapModeU=this.convertWrapMode(e),s.wrapModeV=this.convertWrapMode(t)}}class SpineTemplet extends t.Resource{constructor(){super(),this._textures={}}get ns(){return this._ns}get basePath(){return this._basePath}getTexture(e){return this._textures[e]}_parse(e,s,i,n){let r;return this._basePath=t.URL.getPath(i),r=this.getRuntimeVersion(e).startsWith("4.")?this.parseAtlas4:this.parseAtlas3,r.call(this,s,n).then((t=>{let s=new this._ns.AtlasAttachmentLoader(t);if(e instanceof ArrayBuffer){let t=new this._ns.SkeletonBinary(s);this.skeletonData=t.readSkeletonData(new Uint8Array(e))}else{let t=new this._ns.SkeletonJson(s);this.skeletonData=t.readSkeletonData(e)}}))}getRuntimeVersion(e){return this._ns=spine,SpineTemplet.RuntimeVersion}parseAtlas3(e,s){let i=[];return new this._ns.TextureAtlas(e,(e=>(i.push({url:this._basePath+e}),new SpineTexture(null)))),t.ILaya.loader.load(i,null,null==s?void 0:s.createCallback()).then((t=>{let s=0;return new this._ns.TextureAtlas(e,(e=>{let i=t[s++];i&&i._addReference();let n=new SpineTexture(i);return this._textures[e]=n,n}))}))}parseAtlas4(e,s){let i=new this._ns.TextureAtlas(e);return t.ILaya.loader.load(i.pages.map((e=>this._basePath+e.name)),null,null==s?void 0:s.createCallback()).then((e=>{let t=0;for(let s of i.pages){let i=e[t++];i&&i._addReference();let n=new SpineTexture(i);this._textures[s.name]=n,s.setTexture(n)}return i}))}getAniNameByIndex(e){let t=this.skeletonData.animations[e];return t?t.name:null}getSkinIndexByName(e){let t,s=this.skeletonData.skins;for(let i=0,n=s.length;i<n;i++)if(t=s[i],t.name==e)return i;return-1}_disposeResource(){var e;for(let t in this._textures)null===(e=this._textures[t].realTexture)||void 0===e||e._removeReference()}}SpineTemplet.RuntimeVersion="3.8";const s=[0,1,2,2,3,0];class SpineSkeletonRenderer{constructor(e,t=!0){this.vertexEffect=null,this.tempColor=new spine.Color,this.tempColor2=new spine.Color,this.vertexSize=8,this.twoColorTint=!1,this.temp=new spine.Vector2,this.temp2=new spine.Vector2,this.temp3=new spine.Color,this.temp4=new spine.Color,this.twoColorTint=t,t&&(this.vertexSize+=4),this.templet=e,this.vertices=e.ns.Utils.newFloatArray(1024*this.vertexSize),this.renderable={vertices:null,numVertices:0,numFloats:0},this.clipper=new e.ns.SkeletonClipping}draw(e,i,n=-1,r=-1){let a=this.clipper,l=this.premultipliedAlpha,h=this.temp,o=this.temp2,u=this.temp3,p=this.temp4,m=this.renderable,_=null,d=null,c=e.drawOrder,S=null,k=e.color,g=!1;-1==n&&(g=!0);for(let e=0,x=c.length;e<x;e++){let x=a.isClipping()?2:8,f=c[e];if(n>=0&&n==f.data.index&&(g=!0),!g){a.clipEndWithSlot(f);continue}r>=0&&r==f.data.index&&(g=!1);let y,A=f.getAttachment(),T=null;if(A instanceof this.templet.ns.RegionAttachment){let e=A;m.vertices=this.vertices,m.numVertices=4,m.numFloats=x<<2,"4.1"==SpineTemplet.RuntimeVersion?e.computeWorldVertices(f,m.vertices,0,x):e.computeWorldVertices(f.bone,m.vertices,0,x),d=s,_=e.uvs,T="4.1"==SpineTemplet.RuntimeVersion?e.region.page.name:e.region.renderObject.page.name,y=this.templet.getTexture(T),S=e.color}else{if(!(A instanceof this.templet.ns.MeshAttachment)){if(A instanceof this.templet.ns.ClippingAttachment){let e=A;a.clipStart(f,e);continue}a.clipEndWithSlot(f);continue}{let e=A;m.vertices=this.vertices,m.numVertices=e.worldVerticesLength>>1,m.numFloats=m.numVertices*x,m.numFloats>m.vertices.length&&(m.vertices=this.vertices=this.templet.ns.Utils.newFloatArray(m.numFloats)),e.computeWorldVertices(f,0,e.worldVerticesLength,m.vertices,0,x),d=e.triangles,T="4.1"==SpineTemplet.RuntimeVersion?e.region.page.name:e.region.renderObject.page.name,y=this.templet.getTexture(T),_=e.uvs,S=e.color}}if(null!=y){let e=f.color,s=this.tempColor;s.r=k.r*e.r*S.r,s.g=k.g*e.g*S.g,s.b=k.b*e.b*S.b,s.a=k.a*e.a*S.a,l&&(s.r*=s.a,s.g*=s.a,s.b*=s.a);let n=f.data.blendMode;if(a.isClipping()){a.clipTriangles(m.vertices,m.numFloats,d,d.length,_,s,null,false);let e,r=new Float32Array(a.clippedVertices),l=a.clippedTriangles,c=[],S=[],k=16777215,g=1;if(null!=this.vertexEffect){let e=this.vertexEffect,t=r;for(let s=0,i=r.length;s<i;s+=8)h.x=t[s],h.y=t[s+1],u.set(t[s+2],t[s+3],t[s+4],t[s+5]),o.x=t[s+6],o.y=t[s+7],p.set(0,0,0,0),e.transform(h,o,u,p),t[s]=h.x,t[s+1]=h.y,t[s+2]=u.r,t[s+3]=u.g,t[s+4]=u.b,t[s+5]=u.a,t[s+6]=o.x,t[s+7]=o.y,c.push(t[s],-t[s+1]),k=(255*t[s+2]<<16)+(255*t[s+3]<<8)+t[s+4],g=t[s+5],S.push(t[s+6],t[s+7])}else{let e=0;for(;Number.isFinite(r[e+6])&&Number.isFinite(r[e+7]);)c.push(r[e]),c.push(-r[e+1]),k=(255*r[e+2]<<16)+(255*r[e+3]<<8)+255*r[e+4],g=r[e+5],S.push(r[e+6]),S.push(r[e+7]),e+=this.vertexSize}switch(n){case 1:e="light";break;case 2:e="multiply";break;case 3:e="screen";break;default:e="normal"}i.drawTriangles(y.realTexture,0,0,c,S,new Uint16Array(l),t.Matrix.EMPTY,g,k,e)}else{let e,r=m.vertices,a=[],l=[],c=16777215,S=1;if(null!=this.vertexEffect){let e=this.vertexEffect;for(let t=0,i=0,n=m.numFloats;t<n;t+=8,i+=2)h.x=r[t],h.y=r[t+1],o.x=_[i],o.y=_[i+1],u.setFromColor(s),p.set(0,0,0,0),e.transform(h,o,u,p),r[t]=h.x,r[t+1]=h.y,r[t+2]=u.r,r[t+3]=u.g,r[t+4]=u.b,r[t+5]=u.a,r[t+6]=o.x,r[t+7]=o.y,a.push(r[t],-r[t+1]),c=(255*r[t+2]<<16)+(255*r[t+3]<<8)+255*r[t+4],S=r[t+5],l.push(r[t+6],r[t+7])}else for(let e=2,t=0,i=m.numFloats;e<i;e+=8,t+=2)r[e]=s.r,r[e+1]=s.g,r[e+2]=s.b,r[e+3]=s.a,r[e+4]=_[t],r[e+5]=_[t+1],a.push(r[e-2],-r[e-1]),c=(255*r[e]<<16)+(255*r[e+1]<<8)+255*r[e+2],S=r[e+3],l.push(r[e+4],r[e+5]);switch(n){case 1:e="light";break;case 2:e="multiply";break;case 3:e="screen";break;default:e="normal"}i.drawTriangles(y.realTexture,0,0,a,l,new Uint16Array(d),t.Matrix.EMPTY,S,c,e)}}a.clipEndWithSlot(f)}a.clipEnd()}}class SpineSkeleton extends t.Sprite{constructor(){super(),this._currentPlayTime=0,this._pause=!0,this._currAniName=null,this._playbackRate=1,this._playAudio=!0,this._soundChannelArr=[],this.trackIndex=0,this._skinName="default",this._animationName="",this._loop=!0}get externalSkins(){return this._externalSkins}set externalSkins(e){if(e)for(let t=e.length-1;t>=0;t--)e[t].target=this;this._externalSkins=e}resetExternalSkin(){this._skeleton&&(this._skeleton=new this._templet.ns.Skeleton(this._templet.skeletonData),this._flushExtSkin())}get source(){return this._source}set source(e){this._source=e,e?t.ILaya.loader.load(e,t.Loader.SPINE).then((e=>{!this._source||e&&!e.isCreateFromURL(this._source)||(this.templet=e)})):this.templet=null}get skinName(){return this._skinName}set skinName(e){this._skinName=e,this._templet&&this.showSkinByName(e)}get animationName(){return this._animationName}set animationName(e){this._animationName=e,this._templet&&this.play(e,this._loop,!0)}get loop(){return this._loop}set loop(e){this._loop=e,this._templet&&this.play(this._animationName,this._loop,!0)}get templet(){return this._templet}set templet(e){this.init(e)}set currentTime(e){if(this._currAniName&&this._templet){if((e/=1e3)<this._playStart||this._playEnd&&e>this._playEnd||e>this._duration)throw new Error("AnimationPlayer: value must large than playStartTime,small than playEndTime.");this._state.update(e-this._currentPlayTime),this._currentPlayTime=e}}get playState(){return this._currAniName?this._pause?SpineSkeleton.PAUSED:SpineSkeleton.PLAYING:SpineSkeleton.STOPPED}init(e){if(this._templet&&(this.reset(),this.graphics.clear()),this._templet=e,!this._templet)return;this._templet._addReference(),this._skeleton=new e.ns.Skeleton(this._templet.skeletonData),this._stateData=new e.ns.AnimationStateData(this._skeleton.data),this._state=new e.ns.AnimationState(this._stateData),this._renerer=new SpineSkeletonRenderer(e,!1),this._timeKeeper=new e.ns.TimeKeeper;let s=this._templet.getSkinIndexByName(this._skinName);-1!=s&&this.showSkinByIndex(s),this._state.addListener({start:e=>{},interrupt:e=>{},end:e=>{},dispose:e=>{},complete:e=>{e.loop?this.event(t.Event.COMPLETE):(this._currAniName=null,this.event(t.Event.STOPPED))},event:(s,i)=>{let n={audioValue:i.data.audioPath,audioPath:i.data.audioPath,floatValue:i.floatValue,intValue:i.intValue,name:i.data.name,stringValue:i.stringValue,time:1e3*i.time,balance:i.balance,volume:i.volume};if(this.event(t.Event.LABEL,n),this._playAudio&&n.audioValue){let s=t.SoundManager.playSound(e.basePath+n.audioValue,1,t.Handler.create(this,this._onAniSoundStoped),null,(1e3*this._currentPlayTime-n.time)/1e3);t.SoundManager.playbackRate=this._playbackRate,s&&this._soundChannelArr.push(s)}}}),this._flushExtSkin(),this.event(t.Event.READY),t.LayaEnv.isPlaying&&this._animationName&&this.play(this._animationName,this._loop,!0)}play(e,t,s=!0,i=0,n=0,r=!0,a=!0){this._playAudio=a,n/=1e3;let l=e;if((i/=1e3)<0||n<0)throw new Error("SpineSkeleton: start and end must large than zero.");if(0!==n&&i>n)throw new Error("SpineSkeleton: start must less than end.");if("number"==typeof l&&(l=this.getAniNameByIndex(e)),s||this._pause||this._currAniName!=l){this._currAniName=l,this._state.setAnimation(this.trackIndex,l,t);let e=this._state.getCurrent(this.trackIndex);e.animationStart=i,n&&n<e.animationEnd&&(e.animationEnd=n);let s=e.animation.duration;this._duration=s,this._playStart=i,this._playEnd=n<=s?n:s,this._pause&&(this._pause=!1,this.timer.frameLoop(1,this,this._update,null,!0)),this._update()}}_update(){this._timeKeeper.update();let e=this._timeKeeper.delta*this._playbackRate,t=this._state.getCurrent(this.trackIndex);this._state.update(e),this._state.apply(this._skeleton);let s=t.animationLast;this._currentPlayTime=Math.max(0,s),this._state&&this._skeleton&&(this._skeleton.updateWorldTransform(),this.graphics.clear(),this._renerer.draw(this._skeleton,this.graphics,-1,-1))}_flushExtSkin(){if(null==this._skeleton)return;let e=this._externalSkins;if(e)for(let t=e.length-1;t>=0;t--)e[t].flush()}getAnimNum(){return this._templet.skeletonData.animations.length}getAniNameByIndex(e){return this._templet.getAniNameByIndex(e)}getSlotByName(e){return this._skeleton.findSlot(e)}playbackRate(e){this._playbackRate=e}showSkinByName(e){this.showSkinByIndex(this._templet.getSkinIndexByName(e))}showSkinByIndex(e){let t=this._skeleton.data.skins[e];this._skeleton.setSkin(t),this._skeleton.setSlotsToSetupPose()}stop(){this._pause||(this._pause=!0,this._currAniName=null,this.timer.clear(this,this._update),this._state.update(-this._currentPlayTime),this._currentPlayTime=0,this.event(t.Event.STOPPED),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0))}paused(){if(!this._pause&&(this._pause=!0,this.timer.clear(this,this._update),this.event(t.Event.PAUSED),this._soundChannelArr.length>0))for(let e=this._soundChannelArr.length,t=0;t<e;t++){let e=this._soundChannelArr[t];e.isStopped||e.pause()}}resume(){if(this._pause&&(this._pause=!1,this.timer.frameLoop(1,this,this._update,null,!0),this._soundChannelArr.length>0))for(let e=this._soundChannelArr.length,t=0;t<e;t++){let e=this._soundChannelArr[t];e.audioBuffer&&e.resume()}}_onAniSoundStoped(e){for(let t=this._soundChannelArr.length,s=0;s<t;s++){let i=this._soundChannelArr[s];(i.isStopped||e)&&(!i.isStopped&&i.stop(),this._soundChannelArr.splice(s,1),t--,s--)}}reset(){this._templet._removeReference(1),this._templet=null,this._timeKeeper=null,this._skeleton=null,this._state.clearListeners(),this._state=null,this._renerer=null,this._currAniName=null,this._pause=!0,this.timer.clear(this,this._update),this._soundChannelArr.length>0&&this._onAniSoundStoped(!0)}destroy(e=!0){super.destroy(e),this._templet&&this.reset()}addAnimation(e,t=!1,s=0){s/=1e3;let i=e;"number"==typeof i&&(i=this.getAniNameByIndex(i)),this._currAniName=i,this._state.addAnimation(this.trackIndex,i,t,s)}setMix(e,t,s){s/=1e3;let i=e;"number"==typeof i&&(i=this.getAniNameByIndex(i));let n=t;"number"==typeof n&&(n=this.getAniNameByIndex(n)),this._stateData.setMix(i,n,s)}getBoneByName(e){return this._skeleton.findBone(e)}getSkeleton(){return this._skeleton}setSlotAttachment(e,t){this._skeleton.setAttachment(e,t)}}SpineSkeleton.STOPPED=0,SpineSkeleton.PAUSED=1,SpineSkeleton.PLAYING=2;t.Loader.registerLoader(["skel"],class{load(e){let s=t.Utils.replaceFileExtension(e.url,"atlas");return Promise.all([e.loader.fetch(e.url,"skel"==e.ext?"arraybuffer":"json",e.progress.createCallback()),e.loader.fetch(s,"text",e.progress.createCallback())]).then((t=>{if(!t[0]||!t[1])return null;let s=new SpineTemplet;return s._parse(t[0],t[1],e.url,e.progress).then((()=>s))}))}},t.Loader.SPINE);let i=t.ClassUtils.regClass;i("SpineSkeleton",SpineSkeleton),i("ExternalSkin",ExternalSkin),i("ExternalSkinItem",ExternalSkinItem),e.ExternalSkin=ExternalSkin,e.ExternalSkinItem=ExternalSkinItem,e.SpineSkeleton=SpineSkeleton,e.SpineSkeletonRenderer=SpineSkeletonRenderer,e.SpineTemplet=SpineTemplet,e.SpineTexture=SpineTexture}(window.Laya=window.Laya||{},Laya);
//# sourceMappingURL=laya.spine.js.map